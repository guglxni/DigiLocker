<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiLocker MeriPehchaan Integration - Production Ready</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D4EA3 0%, #1a5aa8 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .govt-emblem {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .emblem-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #0D4EA3;
        }

        .emblem-icon {
            width: 40px;
            height: 40px;
            background: #0D4EA3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .main-title {
            color: #0D4EA3;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .progress-step.active {
            opacity: 1;
        }

        .progress-step.completed {
            opacity: 1;
            color: #28a745;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .progress-step.active .step-number {
            background: #0D4EA3;
        }

        .progress-step.completed .step-number {
            background: #28a745;
        }

        .auth-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
            align-items: start;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            backdrop-filter: blur(10px);
            min-height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .auth-card:hover {
            transform: translateY(-4px);
        }

        .auth-card h3 {
            color: #0D4EA3;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.3;
        }

        .auth-card p {
            margin-bottom: 20px;
            line-height: 1.5;
            color: #555;
            flex-grow: 0;
        }

        .digilocker-btn {
            background: #0D4EA3;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 32px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }

        .digilocker-btn:hover {
            background: #0a3d7a;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(13, 78, 163, 0.3);
        }

        .digilocker-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .qr-container {
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 16px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .qr-code {
            width: 220px;
            height: 220px;
            border: 3px solid #0D4EA3;
            border-radius: 16px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            box-shadow: 0 6px 24px rgba(13, 78, 163, 0.15);
            transition: all 0.3s ease;
        }

        .qr-code:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 35px rgba(13, 78, 163, 0.25);
        }

        .qr-pattern-container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #0D4EA3;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }

        .qr-static-pattern {
            display: grid;
            grid-template-columns: repeat(25, 1fr);
            gap: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
        }

        .qr-pixel {
            width: 6px;
            height: 6px;
            border-radius: 1px;
        }

        .qr-pixel.black {
            background: #000;
        }

        .qr-pixel.white {
            background: #fff;
        }

        .qr-info-box {
            margin-top: 20px;
            text-align: center;
            color: #333;
            line-height: 1.5;
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        }

        .qr-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            color: #0D4EA3;
        }

        .qr-deep-link {
            font-size: 13px;
            color: #666;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .qr-deep-link code {
            font-size: 11px;
            word-break: break-all;
            color: #495057;
            display: block;
            margin-top: 6px;
            line-height: 1.4;
        }

        .qr-placeholder {
            color: #666;
            font-size: 16px;
            text-align: center;
            padding: 40px 20px;
        }

        .qr-timer {
            font-size: 15px;
            color: #666;
            margin: 15px 0;
            font-weight: 500;
        }

        .refresh-btn {
            margin-top: 15px;
            background: none;
            border: 2px solid #0D4EA3;
            color: #0D4EA3;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            min-width: 160px;
        }

        .refresh-btn:hover {
            background: #0D4EA3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 78, 163, 0.3);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .status-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #ffc107;
            color: white;
        }

        .status-success {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .document-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0D4EA3;
        }

        .document-title {
            font-weight: 600;
            color: #0D4EA3;
            margin-bottom: 10px;
        }

        .document-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .security-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-top: auto;
            border-left: 4px solid #28a745;
            backdrop-filter: blur(10px);
        }

        .security-title {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .security-info ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .security-info li {
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 16px;
            border-radius: 10px;
            margin: 18px 0;
            font-weight: 500;
            line-height: 1.4;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0D4EA3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .compliance-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(13, 78, 163, 0.1);
            color: #0D4EA3;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(13, 78, 163, 0.3);
        }

        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
            .auth-modes {
                gap: 25px;
            }
            
            .auth-card {
                padding: 25px;
                min-height: 550px;
            }
            
            .qr-code {
                width: 200px;
                height: 200px;
            }
        }

        @media (max-width: 768px) {
            .auth-modes {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .auth-card {
                min-height: auto;
                padding: 25px;
            }
            
            .progress-bar {
                flex-direction: column;
                gap: 15px;
                margin: 30px 0;
            }
            
            .progress-step {
                min-width: auto;
                justify-content: center;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .govt-emblem {
                flex-direction: column;
                gap: 15px;
            }
            
            .emblem-item {
                min-width: auto;
                justify-content: center;
            }
            
            .qr-code {
                width: 180px;
                height: 180px;
            }
            
            .qr-container {
                padding: 20px;
                margin: 20px 0;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .compliance-badges {
                gap: 10px;
            }
            
            .badge {
                padding: 8px 14px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .auth-card {
                padding: 20px;
            }
            
            .main-title {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .qr-code {
                width: 160px;
                height: 160px;
            }
            
            .qr-container {
                padding: 15px;
            }
            
            .digilocker-btn {
                padding: 14px 24px;
                font-size: 1rem;
            }
            
            .refresh-btn {
                padding: 10px 20px;
                font-size: 13px;
                min-width: 140px;
            }
            
            .status-container,
            .security-info {
                padding: 20px;
            }
            
            .document-card {
                padding: 20px;
            }
        }

        /* ARIA and Accessibility */
        [role="button"]:focus {
            outline: 2px solid #0D4EA3;
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="govt-emblem">
                <div class="emblem-item">
                    <div class="emblem-icon">🏛️</div>
                    <span>Government of India</span>
                </div>
                <div class="emblem-item">
                    <div class="emblem-icon">🔐</div>
                    <span>MeriPehchaan SSO</span>
                </div>
                <div class="emblem-item">
                    <div class="emblem-icon">📁</div>
                    <span>DigiLocker</span>
                </div>
            </div>
            
            <h1 class="main-title">Secure Document Access</h1>
            <p class="subtitle">Production-ready APISetu + MeriPehchaan Integration</p>
            
            <div class="compliance-badges">
                <span class="badge">MeitY Compliant</span>
                <span class="badge">APISetu v1.12</span>
                <span class="badge">MeriPehchaan v2.3</span>
                <span class="badge">PKCE Enabled</span>
                <span class="badge">5-Year Audit Trail</span>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; border-radius: 10px; color: #856404;">
                <strong>🧪 Demo Mode Active</strong><br>
                This is a mock implementation for evaluation purposes. Authentication flows are simulated.<br>
                In production, this would redirect to the actual MeriPehchaan SSO system.
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" id="step1">
                <div class="step-number">1</div>
                <span>Choose Authentication</span>
            </div>
            <div class="progress-step" id="step2">
                <div class="step-number">2</div>
                <span>MeriPehchaan Login</span>
            </div>
            <div class="progress-step" id="step3">
                <div class="step-number">3</div>
                <span>Access Documents</span>
            </div>
        </div>

        <!-- Authentication Mode Selection -->
        <div id="authModeSelection" class="auth-modes">
            <!-- Same Device Authentication -->
            <div class="auth-card">
                <h3>
                    <span>💻</span>
                    Same Device Authentication
                </h3>
                <p>Continue on this device using your browser. Redirects securely to MeriPehchaan for authentication.</p>
                
                <div class="alert alert-info">
                    <strong>Best for:</strong> Desktop/laptop users, single-device workflows
                </div>
                
                <button class="digilocker-btn" onclick="startSameDeviceAuth()" role="button" aria-label="Sign in with DigiLocker on this device">
                    <span>🔐</span>
                    Sign in with DigiLocker
                </button>
                
                <div class="security-info">
                    <div class="security-title">🛡️ Security Features</div>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>PKCE (Proof Key for Code Exchange)</li>
                        <li>State parameter validation</li>
                        <li>TLS 1.2+ encryption</li>
                        <li>SHA-256 HMAC file integrity</li>
                    </ul>
                </div>
            </div>

            <!-- Cross Device Authentication -->
            <div class="auth-card">
                <h3>
                    <span>📱</span>
                    Cross Device Authentication
                </h3>
                <p>Scan QR code with your mobile device. Perfect for public computers or when mobile DigiLocker app is preferred.</p>
                
                <div class="alert alert-info">
                    <strong>Best for:</strong> Public computers, mobile-first users, enhanced security
                </div>
                
                <button class="digilocker-btn" onclick="startCrossDeviceAuth()" role="button" aria-label="Generate QR code for mobile authentication">
                    <span>📲</span>
                    Generate QR Code
                </button>
                
                <div id="qrContainer" class="qr-container hidden">
                    <div class="qr-code" id="qrCode">
                        <div class="qr-placeholder">Generating QR Code...</div>
                    </div>
                    <div class="qr-timer" id="qrTimer" aria-live="polite">Valid for 60 seconds</div>
                    <button onclick="refreshQR()" class="refresh-btn">
                        🔄 Refresh QR Code
                    </button>
                </div>
                
                <div class="security-info">
                    <div class="security-title">🛡️ Enhanced Security</div>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Device-isolated authentication</li>
                        <li>60-second QR expiry</li>
                        <li>UUID-v4 session rotation</li>
                        <li>No client secrets in QR</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Status Container -->
        <div id="statusContainer" class="status-container hidden">
            <h3 style="color: #0D4EA3; margin-bottom: 20px;">Authentication Status</h3>
            <div id="statusList" aria-live="polite">
                <!-- Status items will be populated here -->
            </div>
        </div>

        <!-- Documents Container -->
        <div id="documentsContainer" class="status-container hidden">
            <h3 style="color: #0D4EA3; margin-bottom: 20px;">Your DigiLocker Documents</h3>
            <div id="documentsList" class="documents-grid">
                <!-- Documents will be populated here -->
            </div>
        </div>

        <!-- Audit Trail -->
        <div class="security-info">
            <div class="security-title">📋 Audit & Compliance</div>
            <p style="margin-top: 10px; color: #666;">
                All interactions are logged for MeitY compliance. Session ID: <span id="sessionId">-</span><br>
                Timestamp: <span id="timestamp">-</span><br>
                Environment: <strong>Mock/Development</strong> (Production endpoints available)
            </p>
        </div>
    </div>

    <script>
        // State Management
        let currentAuthMode = null;
        let sessionId = null;
        let qrTimer = null;
        let statusPolling = null;
        let accessToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            sessionId = generateUUID();
            document.getElementById('sessionId').textContent = sessionId;
            document.getElementById('timestamp').textContent = new Date().toISOString();
            
            // Check if returning from OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') && urlParams.has('state')) {
                handleOAuthCallback(urlParams.get('code'), urlParams.get('state'));
            }
        });

        // Same Device Authentication
        async function startSameDeviceAuth() {
            currentAuthMode = 'same-device';
            updateProgress(2);
            
            try {
                // Generate PKCE parameters
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store PKCE verifier
                sessionStorage.setItem('code_verifier', codeVerifier);
                sessionStorage.setItem('auth_state', sessionId);
                
                showStatus('🧪 Demo Mode: Simulating MeriPehchaan authentication...', 'pending');
                
                // Simulate authentication steps in mock mode
                setTimeout(() => {
                    showStatus('✅ Mock: MeriPehchaan authentication successful', 'success');
                    showStatus('🔄 Mock: Generating authorization code...', 'pending');
                }, 1500);
                
                setTimeout(() => {
                    showStatus('🔑 Mock: Authorization code received', 'success');
                    // Simulate successful callback with mock auth code
                    handleMockAuthSuccess();
                }, 3000);
                
            } catch (error) {
                console.error('Same device auth error:', error);
                showStatus('Authentication failed: ' + error.message, 'error');
            }
        }

        // Cross Device Authentication
        async function startCrossDeviceAuth() {
            currentAuthMode = 'cross-device';
            updateProgress(2);
            
            try {
                // Create device session
                const deviceSession = await createDeviceSession();
                
                // Generate QR content
                const qrContent = `digilocker://auth?state=${deviceSession.id}&client_id=demo_client_id&redirect_uri=${encodeURIComponent(window.location.origin + '/bridge/callback')}`;
                
                // Show QR code container (don't hide auth selection)
                document.getElementById('qrContainer').classList.remove('hidden');
                
                // Generate QR code (in production, use a proper QR library)
                generateQRCode(qrContent);
                
                // Start timer
                startQRTimer(60);
                
                // Start polling for session completion
                startSessionPolling(deviceSession.id);
                
                showStatus('QR Code generated. Scan with your mobile device.', 'pending');
                
            } catch (error) {
                console.error('Cross device auth error:', error);
                showStatus('QR generation failed: ' + error.message, 'error');
            }
        }

        // OAuth Callback Handler
        async function handleOAuthCallback(code, state) {
            if (state !== sessionStorage.getItem('auth_state')) {
                showStatus('State parameter mismatch. Possible CSRF attack.', 'error');
                return;
            }
            
            try {
                showStatus('Processing authorization code...', 'pending');
                
                // Exchange code for token
                const tokenResponse = await exchangeCodeForToken(code);
                accessToken = tokenResponse.access_token;
                
                showStatus('Authentication successful!', 'success');
                updateProgress(3);
                
                // Load user documents
                await loadUserDocuments();
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showStatus('Token exchange failed: ' + error.message, 'error');
            }
        }

        function handleMockAuthSuccess() {
            showStatus('🎉 Mock authentication completed successfully!', 'success');
            accessToken = 'mock_same_device_token_' + Date.now();
            updateProgress(3);
            loadUserDocuments();
        }

        // API Functions (Mock implementations for demo)
        async function createDeviceSession() {
            // Mock API call
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({
                        id: generateUUID(),
                        status: 'PENDING',
                        expires_at: Date.now() + 60000
                    });
                }, 500);
            });
        }

        async function exchangeCodeForToken(code) {
            // Mock token exchange
            showStatus('Exchanging authorization code for access token...', 'pending');
            
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    if (!codeVerifier) {
                        reject(new Error('Code verifier not found'));
                        return;
                    }
                    
                    resolve({
                        access_token: 'mock_access_token_' + Date.now(),
                        refresh_token: 'mock_refresh_token_' + Date.now(),
                        expires_in: 3600,
                        scope: 'files.issueddocs files.uploadeddocs'
                    });
                }, 1500);
            });
        }

        async function loadUserDocuments() {
            try {
                showStatus('Loading your DigiLocker documents...', 'pending');
                
                // Mock document loading
                const documents = await fetchUserDocuments();
                displayDocuments(documents);
                
                showStatus('Documents loaded successfully!', 'success');
                document.getElementById('documentsContainer').classList.remove('hidden');
                
            } catch (error) {
                console.error('Document loading error:', error);
                showStatus('Failed to load documents: ' + error.message, 'error');
            }
        }

        async function fetchUserDocuments() {
            // Mock API call
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve([
                        {
                            uri: 'in.gov.aadhaar.12345678',
                            type: 'AADHAAR',
                            name: 'Aadhaar Card',
                            issuer: 'UIDAI',
                            issued_date: '2023-01-15',
                            verified: true,
                            size: '245 KB',
                            hash: 'sha256:a1b2c3d4...'
                        },
                        {
                            uri: 'in.gov.pan.ABCDE1234F',
                            type: 'PAN',
                            name: 'PAN Card',
                            issuer: 'Income Tax Department',
                            issued_date: '2022-08-20',
                            verified: true,
                            size: '180 KB',
                            hash: 'sha256:e5f6g7h8...'
                        },
                        {
                            uri: 'in.gov.dl.MH1234567890',
                            type: 'DRIVING_LICENSE',
                            name: 'Driving License',
                            issuer: 'Maharashtra RTO',
                            issued_date: '2024-03-10',
                            verified: true,
                            size: '320 KB',
                            hash: 'sha256:i9j0k1l2...'
                        }
                    ]);
                }, 1000);
            });
        }

        // UI Helper Functions
        function updateProgress(step) {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i < step) {
                    stepEl.className = 'progress-step completed';
                } else if (i === step) {
                    stepEl.className = 'progress-step active';
                } else {
                    stepEl.className = 'progress-step';
                }
            }
        }

        function showStatus(message, type) {
            const statusContainer = document.getElementById('statusContainer');
            const statusList = document.getElementById('statusList');
            
            statusContainer.classList.remove('hidden');
            
            const statusItem = document.createElement('div');
            statusItem.className = 'status-item';
            
            const icon = document.createElement('div');
            icon.className = `status-icon status-${type}`;
            icon.textContent = type === 'pending' ? '⏳' : type === 'success' ? '✓' : '✗';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            const timestamp = document.createElement('small');
            timestamp.style.marginLeft = 'auto';
            timestamp.style.color = '#666';
            timestamp.textContent = new Date().toLocaleTimeString();
            
            statusItem.appendChild(icon);
            statusItem.appendChild(text);
            statusItem.appendChild(timestamp);
            
            statusList.appendChild(statusItem);
            statusList.scrollTop = statusList.scrollHeight;
        }

        function displayDocuments(documents) {
            const documentsList = document.getElementById('documentsList');
            documentsList.innerHTML = '';
            
            documents.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                
                card.innerHTML = `
                    <div class="document-title">${doc.name}</div>
                    <div class="document-meta">
                        <strong>Issuer:</strong> ${doc.issuer}<br>
                        <strong>Issued:</strong> ${doc.issued_date}<br>
                        <strong>Size:</strong> ${doc.size}<br>
                        <strong>Verified:</strong> ${doc.verified ? '✓ Yes' : '✗ No'}<br>
                        <strong>Hash:</strong> <code style="font-size: 0.8rem;">${doc.hash}</code>
                    </div>
                    <button class="download-btn" onclick="downloadDocument('${doc.uri}', '${doc.name}')">
                        📄 Download Document
                    </button>
                `;
                
                documentsList.appendChild(card);
            });
        }

        async function downloadDocument(uri, name) {
            try {
                showStatus(`Downloading ${name}...`, 'pending');
                
                // Mock download
                setTimeout(() => {
                    showStatus(`${name} downloaded successfully!`, 'success');
                    
                    // In production, this would be actual file download
                    console.log(`Would download document: ${uri}`);
                }, 1000);
                
            } catch (error) {
                showStatus(`Failed to download ${name}: ${error.message}`, 'error');
            }
        }

        // QR Code Functions
        function generateQRCode(content) {
            const qrCode = document.getElementById('qrCode');
            
            // Create a clean, static QR code
            qrCode.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 15px;">
                    <div class="qr-pattern-container" style="position: relative;">
                        ${generateStaticQRPattern()}
                    </div>
                    <div class="qr-info-box">
                        <div class="qr-header">
                            <span style="font-size: 24px;">📱</span>
                            <span>Scan with DigiLocker App</span>
                        </div>
                        <div style="font-size: 13px; color: #28a745; margin-bottom: 8px;">
                            ✓ Secure cross-device authentication
                        </div>
                        <div class="qr-deep-link">
                            <strong>Deep Link Protocol:</strong>
                            <code>${content.length > 55 ? content.substring(0, 55) + '...' : content}</code>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateStaticQRPattern() {
            // Create a clean 25x25 QR code pattern
            const size = 25;
            const pattern = createQRMatrix(size);
            
            let html = '<div class="qr-static-pattern">';
            
            for (let i = 0; i < size * size; i++) {
                const isBlack = pattern[i];
                html += `<div class="qr-pixel ${isBlack ? 'black' : 'white'}"></div>`;
            }
            
            html += '</div>';
            return html;
        }

        function createQRMatrix(size) {
            const matrix = new Array(size * size).fill(false);
            
            // Helper function to set a square pattern
            function setSquare(x, y, size, filled) {
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        const idx = (y + i) * 25 + (x + j);
                        if (idx >= 0 && idx < matrix.length) {
                            matrix[idx] = filled;
                        }
                    }
                }
            }
            
            // Helper function to set a single pixel
            function setPixel(x, y, filled) {
                const idx = y * 25 + x;
                if (idx >= 0 && idx < matrix.length && x >= 0 && x < 25 && y >= 0 && y < 25) {
                    matrix[idx] = filled;
                }
            }
            
            // Create positioning squares (finder patterns)
            // Top-left
            setSquare(0, 0, 7, true);
            setSquare(1, 1, 5, false);
            setSquare(2, 2, 3, true);
            
            // Top-right
            setSquare(18, 0, 7, true);
            setSquare(19, 1, 5, false);
            setSquare(20, 2, 3, true);
            
            // Bottom-left
            setSquare(0, 18, 7, true);
            setSquare(1, 19, 5, false);
            setSquare(2, 20, 3, true);
            
            // Timing patterns (alternating black/white)
            for (let i = 8; i < 17; i++) {
                setPixel(i, 6, i % 2 === 0); // Horizontal timing
                setPixel(6, i, i % 2 === 0); // Vertical timing
            }
            
            // Dark module (always black)
            setPixel(8, 13, true);
            
            // Add some realistic data patterns
            const dataPattern = [
                // Row 8
                false, true, false, true, true, false, true, false, true,
                // Row 9
                true, false, true, false, false, true, false, true, false,
                // Row 10
                false, true, true, false, true, true, false, false, true,
                // Row 11
                true, false, false, true, false, false, true, true, false,
                // Row 12
                false, true, false, true, true, false, false, false, true,
                // Continue pattern...
                true, false, true, false, false, true, true, false, false,
                false, true, false, true, true, false, false, true, true,
                true, false, true, false, false, true, false, false, false,
                false, true, true, false, true, false, true, true, false,
                true, false, false, true, false, true, false, false, true,
                false, true, false, true, true, false, true, false, false,
                true, false, true, false, false, true, false, true, true,
                false, true, true, false, true, false, false, false, false,
                true, false, false, true, false, true, true, true, false,
                false, true, false, true, true, false, false, false, true,
                true, false, true, false, false, true, true, false, false
            ];
            
            // Fill in data areas (avoiding positioning squares and timing patterns)
            let dataIndex = 0;
            for (let y = 0; y < 25; y++) {
                for (let x = 0; x < 25; x++) {
                    // Skip positioning squares and timing patterns
                    if ((x < 9 && y < 9) || // Top-left
                        (x >= 17 && y < 9) || // Top-right  
                        (x < 9 && y >= 17) || // Bottom-left
                        (x === 6 || y === 6)) { // Timing patterns
                        continue;
                    }
                    
                    if (dataIndex < dataPattern.length) {
                        setPixel(x, y, dataPattern[dataIndex]);
                        dataIndex++;
                    } else {
                        // Create pseudo-random pattern for remaining areas
                        const pseudoRandom = (x * 7 + y * 11 + dataIndex) % 3;
                        setPixel(x, y, pseudoRandom === 0);
                        dataIndex++;
                    }
                }
            }
            
            return matrix;
        }

        function startQRTimer(seconds) {
            let remaining = seconds;
            const timerEl = document.getElementById('qrTimer');
            
            qrTimer = setInterval(() => {
                remaining--;
                timerEl.textContent = `Valid for ${remaining} seconds`;
                
                if (remaining <= 0) {
                    clearInterval(qrTimer);
                    timerEl.textContent = 'QR Code expired - click Refresh';
                    timerEl.style.color = '#dc3545';
                }
            }, 1000);
        }

        function refreshQR() {
            clearInterval(qrTimer);
            document.getElementById('qrTimer').style.color = '#666';
            startCrossDeviceAuth();
        }

        function startSessionPolling(sessionId) {
            // Mock session polling
            let attempts = 0;
            statusPolling = setInterval(() => {
                attempts++;
                
                if (attempts > 30) { // 60 seconds
                    clearInterval(statusPolling);
                    showStatus('Session timeout. Please try again.', 'error');
                    return;
                }
                
                // Simulate successful authentication after 10 seconds
                if (attempts === 10) {
                    clearInterval(statusPolling);
                    handleMobileAuthSuccess();
                }
            }, 2000);
        }

        function handleMobileAuthSuccess() {
            showStatus('Mobile authentication successful!', 'success');
            accessToken = 'mock_mobile_token_' + Date.now();
            updateProgress(3);
            loadUserDocuments();
        }

        // Utility Functions
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function buildAuthUrl(params) {
            // Mock URL - in production, use actual MeriPehchaan endpoint
            const baseUrl = 'https://digilocker.meripehchaan.gov.in/public/oauth2/1/authorize';
            const urlParams = new URLSearchParams(params);
            return `${baseUrl}?${urlParams.toString()}`;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (qrTimer) clearInterval(qrTimer);
            if (statusPolling) clearInterval(statusPolling);
        });
    </script>
</body>
</html> 